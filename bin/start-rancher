#!/usr/bin/env fish

set stopped_appeared_count 0
while true
    set response (rdctl api -X GET /v1/backend_state 2>/dev/null)
    if test -z "$response"
        pgrep "Rancher Desktop" >/dev/null || open -a "Rancher Desktop" --background
    end

    set vm_state (echo $response | yq -p=json '.vmState')

    if test "$vm_state" = "STOPPED"
        set stopped_appeared_count (math $stopped_appeared_count + 1)
        if test "$stopped_appeared_count" -eq 1
            exit
        end
    else if test "$vm_state" != "STARTING" && test "$vm_state" != "null"
        exit
    end

    echo -ne "\rEngine is starting..."
    sleep 0.3
end
